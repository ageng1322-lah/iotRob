<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Home Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-left">
                <div class="icon-box">
                    <i class="fas fa-home"></i>
                </div>
                <div class="header-text">
                    <h1>Smart Home</h1>
                    <p>Sensor Monitoring</p>
                </div>
            </div>
            <div class="header-right">
                <span class="updated-time">Updated: <span id="clock">08.36.28</span></span>
                <button class="refresh-btn"><i class="fas fa-sync-alt"></i></button>
            </div>
        </header>

        <!-- Hero Section -->
        <section class="hero-card">
            <div class="hero-header">
                <div>
                    <div class="hero-icon-title">
                        <div class="pulse-icon"><i class="fas fa-wave-square"></i></div>
                        <div>
                            <h2>Status Monitoring</h2>
                            <p>Real-time sensor data</p>
                        </div>
                    </div>
                </div>
                <div class="live-badge">
                    <span class="dot"></span> Live
                </div>
            </div>

            <div class="hero-grid">
                <!-- Water -->
                <div class="stat-card">
                    <div class="card-top">
                        <div class="icon-circle water"><i class="fas fa-tint"></i></div>
                        <span class="status-dot online"></span>
                    </div>
                    <div class="card-value">
                        <h3 id="val-water">0</h3>
                        <p>WQI • Air</p>
                    </div>
                </div>

                <!-- Air -->
                <div class="stat-card">
                    <div class="card-top">
                        <div class="icon-circle air"><i class="fas fa-wind"></i></div>
                        <span class="status-dot online"></span>
                    </div>
                    <div class="card-value">
                        <h3 id="val-air">0</h3>
                        <p>AQI • Udara</p>
                    </div>
                </div>

                <!-- Soil -->
                <div class="stat-card">
                    <div class="card-top">
                        <div class="icon-circle soil"><i class="fas fa-mountain"></i></div>
                        <span class="status-dot online"></span>
                    </div>
                    <div class="card-value">
                        <h3 id="val-soil">0</h3>
                        <p>SQI • Tanah</p>
                    </div>
                </div>

                <!-- Electric -->
                <div class="stat-card">
                    <div class="card-top">
                        <div class="icon-circle electric"><i class="fas fa-bolt"></i></div>
                        <span class="status-dot offline"></span>
                    </div>
                    <div class="card-value">
                        <h3 id="val-electric">0</h3>
                        <p>W • Listrik</p>
                    </div>
                </div>
            </div>

            <div class="hero-footer">
                <div class="connection-status">
                    <i class="fas fa-wifi"></i> Koneksi stabil
                </div>
                <div class="refresh-status">Auto-refresh 10s</div>
            </div>
        </section>

        <!-- Detailed Cards Section -->
        <section class="details-grid">
            <!-- Water Detail -->
            <div class="detail-card">
                <div class="detail-header">
                    <div class="icon-sq water"><i class="fas fa-tint"></i></div>
                    <span class="status-dot online"></span>
                </div>
                <p class="label">Kualitas Air</p>
                <div class="value-large">
                    <span id="detail-water">0</span> <span class="unit">WQI</span> <span class="sub-unit">WQI</span>
                </div>
            </div>

            <!-- Air Detail -->
            <div class="detail-card">
                <div class="detail-header">
                    <div class="icon-sq air"><i class="fas fa-wind"></i></div>
                    <span class="status-dot online"></span>
                </div>
                <p class="label">Kualitas Udara</p>
                <div class="value-large">
                    <span id="detail-air">0</span> <span class="unit">AQI</span> <span class="sub-unit">AQI</span>
                </div>
            </div>

            <!-- Soil Detail -->
            <div class="detail-card">
                <div class="detail-header">
                    <div class="icon-sq soil"><i class="fas fa-mountain"></i></div>
                    <span class="status-dot online"></span>
                </div>
                <p class="label">Kualitas Tanah</p>
                <div class="value-large">
                    <span id="detail-soil">0</span> <span class="unit">SQI</span> <span class="sub-unit">SQI</span>
                </div>
            </div>

            <!-- Electric Detail -->
            <div class="detail-card">
                <div class="detail-header">
                    <div class="icon-sq electric"><i class="fas fa-bolt"></i></div>
                    <span class="status-dot offline"></span>
                </div>
                <p class="label">Daya Listrik</p>
                <div class="value-large">
                    <span id="detail-electric">0</span> <span class="unit">W</span> <span class="sub-unit">W</span>
                </div>
            </div>
        </section>

        <!-- Live Monitoring Chart Section -->
        <section class="chart-section">
            <div class="chart-header">
                <h3>Live Monitoring</h3>
                <div class="time-filters">
                    <button>Per Menit</button>
                    <button class="active">Per Jam</button>
                    <button>Per Hari</button>
                </div>
            </div>

            <div class="chart-legend">
                <div class="legend-item"><span class="dot-legend water"></span> Kualitas Air (WQI)</div>
                <div class="legend-item"><span class="dot-legend air"></span> Kualitas Udara (AQI)</div>
                <div class="legend-item"><span class="dot-legend soil"></span> Kualitas Tanah (SQI)</div>
                <div class="legend-item"><span class="dot-legend electric"></span> Daya Listrik (W)</div>
            </div>

            <div class="chart-container" style="position: relative; height: 300px;">
                <canvas id="liveChart"></canvas>
            </div>
        </section>
    </div>

    <script>
        // Update Time
        function updateTime() {
            const now = new Date();
            const h = String(now.getHours()).padStart(2, '0');
            const m = String(now.getMinutes()).padStart(2, '0');
            const s = String(now.getSeconds()).padStart(2, '0');
            document.getElementById('clock').textContent = `${h}.${m}.${s}`;
        }
        setInterval(updateTime, 1000);
        updateTime();

        // -------------------------------------------------------
        // CHART.JS CONFIGURATION
        // -------------------------------------------------------
        const ctx = document.getElementById('liveChart').getContext('2d');
        const liveChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [], // Time labels
                datasets: [
                    {
                        label: 'Kualitas Air (WQI)',
                        borderColor: '#00e5ff', // Accent Blue
                        backgroundColor: 'rgba(0, 229, 255, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Kualitas Udara (AQI)',
                        borderColor: '#00ff88', // Accent Green
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Kualitas Tanah (SQI)',
                        borderColor: '#ffaa00', // Accent Orange
                        backgroundColor: 'rgba(255, 170, 0, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    },
                    {
                        label: 'Daya Listrik (W)',
                        borderColor: '#d600ff', // Accent Purple
                        backgroundColor: 'rgba(214, 0, 255, 0.1)',
                        data: [],
                        tension: 0.4,
                        borderWidth: 2,
                        pointRadius: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false // Using custom legend
                    }
                },
                scales: {
                    x: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#8ab69f'
                        }
                    },
                    y: {
                        grid: {
                            color: 'rgba(255, 255, 255, 0.05)'
                        },
                        ticks: {
                            color: '#8ab69f'
                        },
                        suggestedMax: 100
                    }
                },
                animation: {
                    duration: 0 // Disable animation for smoother updates
                }
            }
        });

        // -------------------------------------------------------
        // FETCH DATA FUNCTION
        // -------------------------------------------------------
        async function fetchData() {
            try {
                // 1. Fetch latest data for counters (Real-time)
                const response = await fetch('api.php');
                const data = await response.json();

                if (!data.error) {
                    // Update Main Cards
                    if (data.kualitas_air !== undefined) {
                        document.getElementById('val-water').innerText = data.kualitas_air;
                        document.getElementById('detail-water').innerText = data.kualitas_air;
                    }
                    if (data.udara !== undefined) {
                        document.getElementById('val-air').innerText = data.udara;
                        document.getElementById('detail-air').innerText = data.udara;
                    }
                    if (data.tahan !== undefined) {
                        document.getElementById('val-soil').innerText = data.tahan;
                        document.getElementById('detail-soil').innerText = data.tahan;
                    }
                    if (data.daya_listrik !== undefined) {
                        document.getElementById('val-electric').innerText = data.daya_listrik;
                        document.getElementById('detail-electric').innerText = data.daya_listrik;
                    }
                }

                // 2. Fetch History Data for Chart
                const historyResponse = await fetch('api.php?mode=history');
                const historyData = await historyResponse.json();

                if (Array.isArray(historyData)) {
                    // Prepare arrays
                    const labels = [];
                    const waterData = [];
                    const airData = [];
                    const soilData = [];
                    const electricData = [];

                    historyData.forEach(item => {
                        // Format timestamp to HH:mm:ss
                        const date = new Date(item.timestamp);
                        const timeStr = date.toLocaleTimeString('id-ID', { hour12: false });

                        labels.push(timeStr);
                        waterData.push(item.kualitas_air);
                        airData.push(item.udara);
                        soilData.push(item.tahan);
                        electricData.push(item.daya_listrik);
                    });

                    // Update Chart Data
                    liveChart.data.labels = labels;
                    liveChart.data.datasets[0].data = waterData;
                    liveChart.data.datasets[1].data = airData;
                    liveChart.data.datasets[2].data = soilData;
                    liveChart.data.datasets[3].data = electricData;

                    liveChart.update();
                }

            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Fetch initially and every 2 seconds
        fetchData();
        setInterval(fetchData, 2000);
    </script>
</body>

</html>